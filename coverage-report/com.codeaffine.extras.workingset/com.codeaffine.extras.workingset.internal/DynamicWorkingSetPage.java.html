<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DynamicWorkingSetPage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Extras for Eclipse Test Coverage</a> &gt; <a href="../index.html" class="el_bundle">com.codeaffine.extras.workingset</a> &gt; <a href="index.source.html" class="el_package">com.codeaffine.extras.workingset.internal</a> &gt; <span class="el_source">DynamicWorkingSetPage.java</span></div><h1>DynamicWorkingSetPage.java</h1><pre class="source lang-java linenums">package com.codeaffine.extras.workingset.internal;

import static com.codeaffine.extras.workingset.internal.Images.WORKING_SET_WIZBAN;
import static org.eclipse.jface.dialogs.Dialog.applyDialogFont;
import static org.eclipse.jface.layout.GridDataFactory.swtDefaults;
import static org.eclipse.jface.viewers.StructuredSelection.EMPTY;
import static org.eclipse.ui.texteditor.ITextEditorActionDefinitionIds.CONTENT_ASSIST_PROPOSALS;

import org.eclipse.jface.dialogs.IMessageProvider;
import org.eclipse.jface.fieldassist.ContentProposalAdapter;
import org.eclipse.jface.fieldassist.TextContentAdapter;
import org.eclipse.jface.layout.GridLayoutFactory;
import org.eclipse.jface.text.FindReplaceDocumentAdapterContentProposalProvider;
import org.eclipse.jface.viewers.ArrayContentProvider;
import org.eclipse.jface.viewers.TableViewer;
import org.eclipse.jface.wizard.WizardPage;
import org.eclipse.swt.SWT;
import org.eclipse.swt.graphics.Color;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.Control;
import org.eclipse.swt.widgets.Event;
import org.eclipse.swt.widgets.Label;
import org.eclipse.swt.widgets.Listener;
import org.eclipse.swt.widgets.Text;
import org.eclipse.ui.IWorkingSet;
import org.eclipse.ui.dialogs.IWorkingSetPage;
import org.eclipse.ui.fieldassist.ContentAssistCommandAdapter;

import com.codeaffine.extras.workingset.internal.ValidationStatus.Severity;


public class DynamicWorkingSetPage extends WizardPage implements  IWorkingSetPage {

  private final ProjectsProvider projectsProvider;
  private final Validator validator;
  private boolean visible;
  private IWorkingSet workingSet;
  Composite composite;
  Text nameText;
  Text patternText;
  Label previewLabel;
  TableViewer previewViewer;
  PreviewLabelProvider previewLabelProvider;

  public DynamicWorkingSetPage() {
<span class="fc" id="L46">    this( new WorkspaceProjectsProvider(), new JdtFeature(), new DynamicWorkingSetFactory() );</span>
<span class="fc" id="L47">  }</span>

  public DynamicWorkingSetPage( ProjectsProvider projectsProvider,
                                JdtFeature jdtFeature,
                                WorkingSetFactory workingSetFactory )
  {
<span class="fc" id="L53">    super( &quot;DynamicWorkingSetWizardPage&quot; );</span>
<span class="fc" id="L54">    this.projectsProvider = projectsProvider;</span>
<span class="fc" id="L55">    this.validator = new Validator( projectsProvider, jdtFeature );</span>
<span class="fc" id="L56">    this.workingSet = workingSetFactory.createWorkingSet();</span>
<span class="fc" id="L57">    setTitle( &quot;Dynamic Project Working Set&quot; );</span>
<span class="fc" id="L58">    setDescription( &quot;Enter a pattern to include matching projects in this working set&quot; );</span>
<span class="fc" id="L59">    setImageDescriptor( Images.getImageDescriptor( WORKING_SET_WIZBAN ) );</span>
<span class="fc" id="L60">  }</span>

  @Override
  public void createControl( Composite parent ) {
<span class="fc" id="L64">    createControls( parent );</span>
<span class="fc" id="L65">    defineTabOrder();</span>
<span class="fc" id="L66">    attachListeners();</span>
<span class="fc" id="L67">    layoutControls();</span>
<span class="fc" id="L68">    setControl( composite );</span>
<span class="fc" id="L69">    applyDialogFont( composite );</span>
<span class="fc" id="L70">    applySelection();</span>
<span class="fc" id="L71">  }</span>

  @Override
  public void setVisible( boolean visible ) {
<span class="fc" id="L75">    super.setVisible( visible );</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">    if( visible ) {</span>
<span class="fc" id="L77">      updateVisibleState();</span>
<span class="fc" id="L78">      updateStatusMessage( new ValidationStatus( Severity.NONE, &quot;&quot; ) );</span>
<span class="fc" id="L79">      setPageComplete( false );</span>
    }
<span class="fc" id="L81">  }</span>

  @Override
  public void finish() {
<span class="fc" id="L85">    workingSet.setName( getPatternText() );</span>
<span class="fc" id="L86">    workingSet.setLabel( getNameText() );</span>
<span class="fc" id="L87">  }</span>

  @Override
  public IWorkingSet getSelection() {
<span class="fc" id="L91">    return workingSet;</span>
  }

  @Override
  public void setSelection( IWorkingSet workingSet ) {
<span class="fc" id="L96">    this.workingSet = workingSet;</span>
<span class="fc" id="L97">  }</span>

  private void createControls( Composite parent ) {
<span class="fc" id="L100">    composite = new Composite( parent, SWT.NONE );</span>
<span class="fc" id="L101">    Label nameLabel = new Label( composite, SWT.NONE );</span>
<span class="fc" id="L102">    nameLabel.setText( &quot;&amp;Name&quot; );</span>
<span class="fc" id="L103">    nameText = new Text( composite, SWT.BORDER );</span>
<span class="fc" id="L104">    Label patternLabel = new Label( composite, SWT.NONE );</span>
<span class="fc" id="L105">    patternLabel.setText( &quot;&amp;Pattern&quot; );</span>
<span class="fc" id="L106">    patternText = new Text( composite, SWT.BORDER );</span>
<span class="fc" id="L107">    installPatternContentAssist();</span>
<span class="fc" id="L108">    previewLabel = new Label( composite, SWT.NONE );</span>
<span class="fc" id="L109">    previewLabel.setText( &quot;Preview&quot; );</span>
<span class="fc" id="L110">    previewViewer = new TableViewer( composite, SWT.SINGLE | SWT.FULL_SELECTION | SWT.BORDER );</span>
<span class="fc" id="L111">    previewViewer.getControl().setBackground( getWidgetBackgroundColor() );</span>
<span class="fc" id="L112">    previewViewer.getControl().addListener( SWT.FocusOut, new PreviewFocusOutListener() );</span>
<span class="fc" id="L113">    previewLabelProvider = new PreviewLabelProvider( getShell().getDisplay() );</span>
<span class="fc" id="L114">    previewViewer.setLabelProvider( previewLabelProvider );</span>
<span class="fc" id="L115">    previewViewer.setContentProvider( ArrayContentProvider.getInstance() );</span>
<span class="fc" id="L116">    previewViewer.setInput( projectsProvider.getProjects() );</span>
<span class="fc" id="L117">    previewViewer.setComparator( new PreviewComparator( &quot;&quot; ) );</span>
<span class="fc" id="L118">  }</span>

  private void layoutControls() {
<span class="fc" id="L121">    composite.setLayout( GridLayoutFactory.swtDefaults().numColumns( 2 ).spacing( 10, 5 ).create() );</span>
<span class="fc" id="L122">    swtDefaults().align( SWT.FILL, SWT.TOP ).grab( true, false ).applyTo( composite );</span>
<span class="fc" id="L123">    swtDefaults().align( SWT.FILL, SWT.CENTER ).grab( true, false ).applyTo( nameText );</span>
<span class="fc" id="L124">    swtDefaults().align( SWT.FILL, SWT.CENTER ).grab( true, false ).applyTo( patternText );</span>
<span class="fc" id="L125">    swtDefaults().align( SWT.FILL, SWT.TOP ).grab( false, false ).indent( 0, 10 ).applyTo( previewLabel );</span>
<span class="fc" id="L126">    swtDefaults()</span>
<span class="fc" id="L127">      .align( SWT.FILL, SWT.FILL )</span>
<span class="fc" id="L128">      .grab( true, true )</span>
<span class="fc" id="L129">      .indent( 0, 10 )</span>
<span class="fc" id="L130">      .hint( SWT.DEFAULT, getPreferredPreviewViewerHeight() )</span>
<span class="fc" id="L131">      .applyTo( previewViewer.getControl() );</span>
<span class="fc" id="L132">  }</span>

  private int getPreferredPreviewViewerHeight() {
<span class="fc" id="L135">    return 10 * previewViewer.getTable().getItemHeight();</span>
  }

  private void installPatternContentAssist() {
<span class="fc" id="L139">    ContentProposalAdapter contentAssist = new ContentAssistCommandAdapter(</span>
<span class="fc" id="L140">      patternText,</span>
<span class="fc" id="L141">      new TextContentAdapter(),</span>
<span class="fc" id="L142">      new FindReplaceDocumentAdapterContentProposalProvider( true ),</span>
<span class="fc" id="L143">      CONTENT_ASSIST_PROPOSALS,</span>
<span class="fc" id="L144">      new char[]{ '\\', '[', '(' },</span>
<span class="fc" id="L145">      true );</span>
<span class="fc" id="L146">    contentAssist.setEnabled( true );</span>
<span class="fc" id="L147">  }</span>

  private void defineTabOrder() {
<span class="fc" id="L150">    composite.setTabList( new Control[] { nameText, patternText } );</span>
<span class="fc" id="L151">  }</span>

  private void attachListeners() {
<span class="fc" id="L154">    nameText.addListener( SWT.Modify, new NameModifyListener() );</span>
<span class="fc" id="L155">    patternText.addListener( SWT.Modify, new PatternModifyListener() );</span>
<span class="fc" id="L156">  }</span>

  private void applySelection() {
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">    if( workingSet != null ) {</span>
<span class="fc" id="L160">      nameText.setText( workingSet.getLabel() );</span>
<span class="fc" id="L161">      patternText.setText( workingSet.getName() );</span>
    }
<span class="fc" id="L163">  }</span>

  private ValidationStatus validate() {
<span class="fc" id="L166">    return validator.validate( workingSet, getNameText(), getPatternText() );</span>
  }

  private void updateVisibleState() {
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">    if( !this.visible ) {</span>
<span class="fc" id="L171">      this.visible = true;</span>
<span class="fc" id="L172">      nameText.setFocus();</span>
    }
<span class="fc" id="L174">  }</span>

  @SuppressWarnings(&quot;incomplete-switch&quot;)
  private void updateStatusMessage( ValidationStatus validationStatus ) {
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if( visible ) {</span>
<span class="fc" id="L179">      int messageType = IMessageProvider.NONE;</span>
<span class="fc" id="L180">      String message = null;</span>
<span class="pc bpc" id="L181" title="1 of 3 branches missed.">      switch( validationStatus.getSeverity() ) {</span>
        case ERROR:
<span class="fc" id="L183">          messageType = IMessageProvider.ERROR;</span>
<span class="fc" id="L184">          message = validationStatus.getMessage();</span>
<span class="fc" id="L185">          break;</span>
        case WARNING:
<span class="nc" id="L187">          messageType = IMessageProvider.WARNING;</span>
<span class="nc" id="L188">          message = validationStatus.getMessage();</span>
          break;
      }
<span class="fc" id="L191">      setMessage( message, messageType );</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">      setPageComplete( validationStatus.getSeverity() != Severity.ERROR );</span>
    }
<span class="fc" id="L194">  }</span>

  private void updatePreview() {
<span class="fc" id="L197">    String pattern = getPatternText();</span>
<span class="fc" id="L198">    previewLabelProvider.setPattern( pattern );</span>
<span class="fc" id="L199">    previewViewer.setComparator( new PreviewComparator( pattern ) );</span>
<span class="fc" id="L200">  }</span>

  private String getPatternText() {
<span class="fc" id="L203">    return patternText.getText().trim();</span>
  }

  private String getNameText() {
<span class="fc" id="L207">    return nameText.getText().trim();</span>
  }

  private Color getWidgetBackgroundColor() {
<span class="fc" id="L211">    return getShell().getDisplay().getSystemColor( SWT.COLOR_WIDGET_BACKGROUND );</span>
  }

<span class="fc" id="L214">  private class NameModifyListener implements Listener {</span>
    @Override
    public void handleEvent( Event event ) {
<span class="fc" id="L217">      updateStatusMessage( validate() );</span>
<span class="fc" id="L218">    }</span>
  }

<span class="fc" id="L221">  private class PatternModifyListener implements Listener {</span>
    @Override
    public void handleEvent( Event event ) {
<span class="fc" id="L224">      updateStatusMessage( validate() );</span>
<span class="fc" id="L225">      updatePreview();</span>
<span class="fc" id="L226">    }</span>
  }

<span class="fc" id="L229">  private class PreviewFocusOutListener implements Listener {</span>
    @Override
    public void handleEvent( Event event ) {
<span class="nc" id="L232">      previewViewer.setSelection( EMPTY );</span>
<span class="nc" id="L233">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>